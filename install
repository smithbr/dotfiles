#!/usr/bin/env bash

set -euo pipefail

basedir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
bootstrap="$basedir/.yadm/bootstrap"
brew_script="$basedir/homebrew/brew.sh"

if [[ ! -f "$bootstrap" ]];
then
    echo "missing bootstrap script: $bootstrap" >&2
    exit 1
fi

if ! command -v yadm >/dev/null 2>&1;
then
    [[ -x "$brew_script" ]] || chmod +x "$brew_script"
    "$brew_script"
fi

if ! command -v yadm >/dev/null 2>&1;
then
    echo "yadm is not installed; ensure homebrew/Brewfile includes yadm" >&2
    exit 1
fi

if ! yadm rev-parse --git-dir >/dev/null 2>&1;
then
    yadm clone --no-bootstrap "$basedir"
fi

if [[ -d "$basedir/.git" ]];
then
    if ! git -C "$basedir" diff --quiet || ! git -C "$basedir" diff --cached --quiet || [[ -n "$(git -C "$basedir" ls-files --others --exclude-standard)" ]];
    then
        echo "source repo has uncommitted changes; yadm can only checkout committed files." >&2
        echo "commit or stash changes in $basedir, then rerun ./install." >&2
        exit 1
    fi
fi

if ! yadm checkout;
then
    echo "yadm checkout reported conflicts in \$HOME; resolve conflicts and rerun." >&2
    exit 1
fi

[[ -x "$bootstrap" ]] || chmod +x "$bootstrap"
exec "$bootstrap" ${@+"$@"}
